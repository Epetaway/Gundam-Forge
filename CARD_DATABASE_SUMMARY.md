# Gundam Forge Card Database System — Summary

**Last Updated**: 2026-02-25
**Status**: Active Development
**Build**: Next.js 14 static export → `apps/web/out/`

---

## Overview

The Gundam Forge card database is a self-contained JSON file bundled with the web app, backed by a set of TypeScript ETL scripts that sync and download assets from the official source at `https://exburst.dev/`.

**Key Stats:**
- **471 cards** in `apps/web/src/data/cards.json`
- **Local card art** downloaded to `apps/web/public/card_art/{id}.webp`
- **Image source**: `https://exburst.dev/gundam/cards/sd/{id}.webp`
- **Schema**: `CardDefinition` (runtime) + `ExtendedCardDefinitionSchema` (Zod, for ETL validation)

---

## 1. Card Data File

**Path**: `apps/web/src/data/cards.json`

Contains 471 `CardDefinition` objects loaded at startup by `cardsStore.ts`. This file is the single source of truth for the running app — it is committed to the repo and regenerated by the sync scripts.

**Runtime card shape** (from `packages/shared/src/types.ts`):

```typescript
interface CardDefinition {
  id: string;            // e.g. "GD01-001"
  name: string;
  color: CardColor;      // Blue | Green | Red | White | Purple | Colorless
  cost: number;
  type: CardType;        // Unit | Pilot | Command | Base | Resource
  set: string;
  text?: string;

  // Official game stats
  ap?: number;           // Attack Points
  hp?: number;           // Hit Points
  level?: number;        // Resource cost (defaults to cost)
  traits?: string[];
  zone?: string;
  linkCondition?: string;
  apModifier?: number;   // Pilot AP bonus
  hpModifier?: number;   // Pilot HP bonus
  power?: number;        // Legacy fallback for ap

  // Asset & pricing
  imageUrl?: string;     // "/card_art/{id}.webp" after fetch-assets runs
  placeholderArt?: string;
  price?: CardPrice;     // { market?, low?, mid?, high?, foil? }
}
```

---

## 2. Package Structure

```
packages/shared/src/
├── types.ts             # CardDefinition, CardColor, CardType, CardPrice
├── card-schema.ts       # Zod ExtendedCardDefinitionSchema (ETL validation)
├── card-sources.ts      # Data sources registry
├── validation.ts        # Deck validation rules
├── game-engine.ts       # Game rules helpers
├── playmat-zones.ts     # Playmat zone definitions
├── price-api.ts         # PriceAPIManager, MockPriceSource, TCGPlayerPriceSource, CardmarketPriceSource
└── index.ts             # Re-exports everything

apps/web/
├── src/data/cards.json              # 471 cards — runtime database
├── public/card_art/                 # Downloaded .webp files
├── src/utils/resolveCardImage.ts    # Image URL resolution + fallback helpers
├── src/components/ui/CardImage.tsx  # React component with self-healing fallback chain
└── out/                             # Next.js static export (build artifact)

scripts/
├── sync-official-cards.ts    # Scrape card list from exburst.dev, update cards.json
├── fetchCardAssets.ts        # Download card art images, update imageUrl fields
├── sync-official-decks.ts    # Sync official deck lists
├── sync-cards-from-xlsx.ts   # Import cards from spreadsheet
├── fetch-hq-images.ts        # Fetch high-resolution card art
├── fetch-cards.ts            # Legacy ETL script
└── validate-cards.ts         # Validate cards.json against Zod schema
```

---

## 3. ETL Scripts (npm run)

| Command | Script | Purpose |
|---------|--------|---------|
| `npm run sync-cards` | `sync-official-cards.ts` | Scrape card list from `https://exburst.dev/gundam/cardlist`, write to `cards.json` |
| `npm run fetch-assets` | `fetchCardAssets.ts` | Download `.webp` art from exburst.dev, set `imageUrl`, fetch prices |
| `npm run sync-decks` | `sync-official-decks.ts` | Sync official deck data |
| `npm run sync-cards-xlsx` | `sync-cards-from-xlsx.ts` | Import from `.xlsx` spreadsheet |
| `npm run fetch-hq-images` | `fetch-hq-images.ts` | Fetch high-res art variants |

### `fetchCardAssets.ts` — Key Behavior

- **Source**: `https://exburst.dev/gundam/cards/sd/{id}.webp`
- **Concurrency**: 10 parallel downloads (env: `CONCURRENCY`)
- **Skip-existing**: checks `public/card_art/{id}.webp` before fetching
- **Updates `imageUrl`**: sets `card.imageUrl = "/card_art/{id}.webp"` on success
- **Minimum size guard**: rejects files < 5 KB (error pages)
- **Price integration**: can call TCGPlayer or Cardmarket APIs (defaults to mock)

### `sync-official-cards.ts` — Key Behavior

- **Default source URL**: `https://exburst.dev/gundam/cardlist`
- Supports optional Playwright for JS-rendered pages (`GUNDAM_GCG_USE_PLAYWRIGHT`)
- Merges scraped data into existing `cards.json` by card ID (no duplicates)

---

## 4. Image System

### Fallback Chain (runtime, managed by `CardImage.tsx`)

```
1. Local /card_art/{id}.webp      — downloaded by fetch-assets, fastest
2. https://exburst.dev/gundam/cards/sd/{id}.webp  — canonical upstream
3. placeholderArt (placehold.co)  — always-available SVG (skipped in hideOnFail mode)
4. Inline text tile               — last resort (skipped in hideOnFail mode)
```

### `hideOnFail` mode

Cards in the catalog (`ModernCardCatalog`, `CardGrid`) use `hideOnFail={true}` on `CardImage`. When both local and remote sources fail (card has no real art), the card is removed from the visible grid via `useBrokenImageStore`. These cards are likely unpublished or invalid entries.

### Path Resolution (`resolveCardImage.ts`)

- Converts `exburst.dev` and `gundam-gcg.com` URLs to local `/card_art/` paths
- Prepends `NEXT_PUBLIC_BASE_PATH` (`/Gundam-Forge` in prod, `''` in dev) to local paths
- `getCardFallbacks(card)` returns the full ordered fallback array

---

## 5. Extended Schema (ETL / Validation)

`ExtendedCardDefinitionSchema` in `card-schema.ts` is a Zod schema used by the ETL scripts and `validate-cards.ts`. It is **stricter than the runtime `CardDefinition`** — it adds:

- `rarity`: `Common | Uncommon | Rare | Special Rare | Promo`
- `setCode`, `setName`, `releaseDate`
- `artUrl`, `artUrlThumb`, `illustrator`
- `legal`, `bannedDate`, `ruling`, `rulingUrl`, `errata`
- `tags[]`: archetype/mechanic tags (e.g. `Newtype`, `Zeon`, `Federation`, `Mobile-Suit`)
- `source`, `sourceUrl`, `lastUpdated`, `internal`
- ID regex: `/^[A-Z]{2,3}-\d{3,4}$/`
- Set code regex: `/^[A-Z]+-\d+$/`

The runtime app does **not** use `ExtendedCardDefinition` — it operates on the lighter `CardDefinition` type.

---

## 6. Deployment

- **Build tool**: Next.js 14 (`output: 'export'`)
- **Output dir**: `apps/web/out/`
- **Deploy target**: GitHub Pages at `https://epetaway.github.io/Gundam-Forge/`
- **CI workflow**: `.github/workflows/deploy.yml`
  - Downloads card art at build time (`npm run fetch-assets`)
  - Runs `next build` → exports to `apps/web/out/`
  - Uploads `apps/web/out/` to GitHub Pages
- **basePath**: `/Gundam-Forge` (production only, controlled by `NEXT_PUBLIC_BASE_PATH`)

---

## 7. Development

```bash
# Install dependencies
npm install

# Start local dev server (http://localhost:3000/)
npm run dev:web

# Sync latest card list from exburst.dev
npm run sync-cards

# Download card art images
npm run fetch-assets

# Full build
npm run build

# Lint + build
npm run qa

# Tests
npm run test
```

---

## 8. Known Gaps / Future Work

- Some cards in `cards.json` have no art on exburst.dev (fail both local + remote lookups) — these are hidden in catalog/grid views via `hideOnFail`. They may be pre-release, promotional, or data errors.
- Price data defaults to mock values; real pricing requires `TCGPLAYER_PUBLIC_KEY`/`TCGPLAYER_PRIVATE_KEY` or `CARDMARKET_API_KEY` env vars.
- `ExtendedCardDefinition` (Zod) is not yet enforced at sync time — `validate-cards.ts` must be run manually.
- No automated weekly sync job is configured; sync scripts are run manually or as part of the CI build.
